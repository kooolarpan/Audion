name: Release
on:
  push:
    branches:
      - master
    paths:
      - "src-tauri/tauri.conf.json"
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - windows
          - linux
          - macos
          - all
permissions:
  contents: write
jobs:
  release-windows:
    runs-on: windows-latest
    if: ${{ github.event_name == 'push' || inputs.platform == 'windows' || inputs.platform == 'all' }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      # 1. Checkout repository (need full history for tags)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. Read version from tauri.conf.json
      - name: Read app version
        id: version
        shell: pwsh
        run: |
          $json = Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json
          if (-not $json.version) {
            Write-Error "Version not found in tauri.conf.json"
            exit 1
          }
          echo "version=$($json.version)" >> $env:GITHUB_OUTPUT
      
      # 3. Prevent duplicate releases
      - name: Check if version tag already exists
        shell: pwsh
        run: |
          git fetch --tags
          if (git tag -l "v${{ steps.version.outputs.version }}") {
            Write-Error "Release v${{ steps.version.outputs.version }} already exists"
            exit 1
          }
      
      # 4. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      
      # 5. Setup Rust
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      # 6. Rust cache
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      # 7. Install frontend dependencies
      - name: Install dependencies
        run: npm install
      
      # 8. Build Tauri app (unsigned)
      - name: Build Tauri app
        run: npm run tauri build
      
      # 9. Verify build artifacts
      - name: Verify build artifacts
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "src-tauri/target/release/bundle/msi/*.msi"
          $nsis = Get-ChildItem -Path "src-tauri/target/release/bundle/nsis/*.exe"
          if (-not $msi -or -not $nsis) {
            Write-Error "Build artifacts not found"
            exit 1
          }
      
      # 10. Read release notes from file
      - name: Read release notes
        id: changelog
        shell: pwsh
        run: |
          # Check if releasenote.md exists
          if (-not (Test-Path "releasenote.md")) {
            Write-Error "releasenote.md not found in repository root"
            exit 1
          }
          
          # Read the content
          $content = Get-Content "releasenote.md" -Raw -Encoding utf8
          
          if ([string]::IsNullOrWhiteSpace($content)) {
            Write-Error "releasenote.md is empty"
            exit 1
          }
          
          # Set multiline output for GitHub Actions
          $delimiter = "EOF_$(New-Guid)"
          echo "content<<$delimiter" >> $env:GITHUB_OUTPUT
          echo $content >> $env:GITHUB_OUTPUT
          echo $delimiter >> $env:GITHUB_OUTPUT
      
      # 11. Create GitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.content }}
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 12. Get file information for Discord
      - name: Get release file info
        id: file_info
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "src-tauri/target/release/bundle/msi/*.msi" | Select-Object -First 1
          $nsis = Get-ChildItem -Path "src-tauri/target/release/bundle/nsis/*.exe" | Select-Object -First 1
          
          $msiSize = [math]::Round($msi.Length / 1MB, 2)
          $nsisSize = [math]::Round($nsis.Length / 1MB, 2)
          
          echo "msi_name=$($msi.Name)" >> $env:GITHUB_OUTPUT
          echo "msi_size=$msiSize MB" >> $env:GITHUB_OUTPUT
          echo "nsis_name=$($nsis.Name)" >> $env:GITHUB_OUTPUT
          echo "nsis_size=$nsisSize MB" >> $env:GITHUB_OUTPUT
      
      # 13. Send Discord notification
      # 13. Send Discord notification
      - name: Discord notification
        if: success()
        shell: pwsh
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CHANGELOG_CONTENT: ${{ steps.changelog.outputs.content }}
          VERSION: ${{ steps.version.outputs.version }}
          MSI_NAME: ${{ steps.file_info.outputs.msi_name }}
          MSI_SIZE: ${{ steps.file_info.outputs.msi_size }}
          NSIS_NAME: ${{ steps.file_info.outputs.nsis_name }}
          NSIS_SIZE: ${{ steps.file_info.outputs.nsis_size }}
        run: |
          if (-not $env:DISCORD_WEBHOOK_URL) {
            Write-Warning "DISCORD_WEBHOOK_URL secret is not set. Skipping notification."
            return
          }

          $changelog = $env:CHANGELOG_CONTENT
          if ($changelog.Length -gt 1024) {
            $changelog = $changelog.Substring(0, 1021) + "..."
          }

          $payload = @{
            content = "@everyone"
            embeds = @(
              @{
                title = "üöÄ New Release: v$env:VERSION"
                description = "A new Windows release has been published!"
                color = 3066993  # Green color
                fields = @(
                  @{
                    name = "üì¶ MSI Installer"
                    value = "``$env:MSI_NAME`` ($env:MSI_SIZE)"
                    inline = $false
                  },
                  @{
                    name = "üì¶ NSIS Installer"
                    value = "``$env:NSIS_NAME`` ($env:NSIS_SIZE)"
                    inline = $false
                  },
                  @{
                    name = "üìù Changelog"
                    value = $changelog
                    inline = $false
                  }
                )
                url = "https://github.com/${{ github.repository }}/releases/tag/v$env:VERSION"
                timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
                footer = @{
                  text = "Released by ${{ github.actor }}"
                }
              }
            )
          } | ConvertTo-Json -Depth 10
          
          Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK_URL -Method Post -Body $payload -ContentType "application/json"

  release-linux:
    runs-on: ubuntu-latest
    needs: release-windows
    # Allow running even if Windows was skipped (for linux-only builds), or if Windows passed
    if: ${{ always() && (github.event_name == 'push' || inputs.platform == 'linux' || inputs.platform == 'all') && (needs.release-windows.result == 'success' || needs.release-windows.result == 'skipped') }}
    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Read version from tauri.conf.json (for standalone runs)
      - name: Read app version
        id: version
        run: |
          VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 3. Install Linux dependencies
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev xvfb

      # 4. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      # 5. Setup Rust
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # 6. Rust cache
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # 7. Install frontend dependencies
      - name: Install dependencies
        run: npm install

      # 8. Build Tauri app for Linux
      - name: Build Tauri app
        run: xvfb-run npm run tauri build

      # 9. Verify build artifacts
      - name: Verify build artifacts
        run: |
          ls -la src-tauri/target/release/bundle/deb/ || echo "No .deb found"
          ls -la src-tauri/target/release/bundle/appimage/ || echo "No .AppImage found"

      # 10. Upload Linux artifacts (creates or updates release)
      - name: Upload Linux artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          files: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 11. Send Discord notification for Linux
      - name: Discord notification (Linux)
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL secret is not set. Skipping notification."
            exit 0
          fi

          DEB_FILE=$(ls src-tauri/target/release/bundle/deb/*.deb 2>/dev/null | head -1)
          APPIMAGE_FILE=$(ls src-tauri/target/release/bundle/appimage/*.AppImage 2>/dev/null | head -1)

          DEB_NAME=$(basename "$DEB_FILE" 2>/dev/null || echo "N/A")
          APPIMAGE_NAME=$(basename "$APPIMAGE_FILE" 2>/dev/null || echo "N/A")

          DEB_SIZE=$(du -h "$DEB_FILE" 2>/dev/null | cut -f1 || echo "N/A")
          APPIMAGE_SIZE=$(du -h "$APPIMAGE_FILE" 2>/dev/null | cut -f1 || echo "N/A")

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"content\": \"@everyone\",
              \"embeds\": [{
                \"title\": \"üêß Linux Release Added: v${VERSION}\",
                \"description\": \"Linux builds have been added to the release!\",
                \"color\": 16742144,
                \"fields\": [
                  {\"name\": \"üì¶ DEB Package\", \"value\": \"\`${DEB_NAME}\` (${DEB_SIZE})\", \"inline\": false},
                  {\"name\": \"üì¶ AppImage\", \"value\": \"\`${APPIMAGE_NAME}\` (${APPIMAGE_SIZE})\", \"inline\": false}
                ],
                \"url\": \"https://github.com/${{ github.repository }}/releases/tag/v${VERSION}\",
                \"footer\": {\"text\": \"Released by ${{ github.actor }}\"}
              }]
            }" \
            "$DISCORD_WEBHOOK_URL"

  release-macos:
    runs-on: macos-latest
    needs: [release-windows, release-linux]
    # Allow running if previous jobs succeeded or were skipped, and platform matches
    if: ${{ always() && (github.event_name == 'push' || inputs.platform == 'macos' || inputs.platform == 'all') && (needs.release-windows.result == 'success' || needs.release-windows.result == 'skipped') }}
    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Read version from tauri.conf.json
      - name: Read app version
        id: version
        run: |
          VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 3. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      # 4. Setup Rust
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin aarch64-apple-darwin

      # 5. Rust cache
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # 6. Install frontend dependencies
      - name: Install dependencies
        run: npm install

      # 7. Build Tauri app for macOS (Universal)
      - name: Build Tauri app
        run: npm run tauri build -- --target universal-apple-darwin

      # 8. Upload macOS artifacts
      - name: Upload macOS artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          files: |
            src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app.tar.gz
            src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9. Send Discord notification for macOS
      - name: Discord notification (macOS)
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL secret is not set. Skipping notification."
            exit 0
          fi

          DMG_FILE=$(ls src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg 2>/dev/null | head -1)
          APP_tar_FILE=$(ls src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app.tar.gz 2>/dev/null | head -1)

          DMG_NAME=$(basename "$DMG_FILE" 2>/dev/null || echo "N/A")
          APP_tar_NAME=$(basename "$APP_tar_FILE" 2>/dev/null || echo "N/A")

          DMG_SIZE=$(du -h "$DMG_FILE" 2>/dev/null | cut -f1 || echo "N/A")
          APP_tar_SIZE=$(du -h "$APP_tar_FILE" 2>/dev/null | cut -f1 || echo "N/A")

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"content\": \"@everyone\",
              \"embeds\": [{
                \"title\": \"üçé macOS Release Added: v${VERSION}\",
                \"description\": \"macOS builds have been added to the release!\",
                \"color\": 15158332,
                \"fields\": [
                  {\"name\": \"üì¶ DMG Package\", \"value\": \"\`${DMG_NAME}\` (${DMG_SIZE})\", \"inline\": false},
                  {\"name\": \"üì¶ App Bundle (tar.gz)\", \"value\": \"\`${APP_tar_NAME}\` (${APP_tar_SIZE})\", \"inline\": false}
                ],
                \"url\": \"https://github.com/${{ github.repository }}/releases/tag/v${VERSION}\",
                \"footer\": {\"text\": \"Released by ${{ github.actor }}\"}
              }]
            }" \
            "$DISCORD_WEBHOOK_URL"
